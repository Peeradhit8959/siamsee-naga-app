<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
    // --- ❗️❗️ สำคัญ: แก้ไข LIFF ID และ Web App URL ของคุณตรงนี้ ❗️❗️ ---
    const LIFF_ID = "2007499712-ljGY76Pk"; // ใส่ LIFF ID ของคุณณ
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyNFs7OW9pjpKlEX39PY4rV48tNDXPKxeSoWbWZf9Tk3Z-u4j9JJozZEDmYSlZTZuqk/exec
"; // ใส่ URL ที่ได้จากการ Deploy

    window.onload = function() {
        liff.init({ liffId: LIFF_ID })
            .then(() => {
                fetchFortuneData();
            })
            .catch((err) => {
                console.error(err);
                document.getElementById("loading-indicator").innerHTML = `<p>เกิดข้อผิดพลาดในการเปิด LIFF App</p><p><small>${err}</small></p>`;
            });
    };

    function fetchFortuneData() {
        // ใช้ fetch เพื่อยิง request ไปยัง Google Apps Script
        fetch(WEB_APP_URL + "?action=getFortune") // เพิ่ม ?action=getFortune เพื่อบอกให้สคริปต์รู้ว่าเราต้องการอะไร
            .then(response => response.json())
            .then(data => {
                displayFortune(data);
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                displayError("ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์คำทำนายได้");
            });
    }

    function displayFortune(data) {
        if (data && data.status === "success") {
            const fortune = data.payload;
            document.getElementById("fortune-number").innerText = `เลขที่ ${fortune['เลขที่'] || '?'}`;
            document.getElementById("fortune-title").innerText = fortune['ชื่อใบเซียมซี'] || 'ใบเซียมซีมงคล';
            document.getElementById("fortune-main").innerText = fortune['ชะตาทั่วไป'] || '-';
            document.getElementById("fortune-work").innerText = fortune['การงาน'] || '-';
            document.getElementById("fortune-finance").innerText = fortune['การเงิน'] || '-';
            document.getElementById("fortune-love").innerText = fortune['ความรัก'] || '-';
            document.getElementById("fortune-health").innerText = fortune['สุขภาพ'] || '-';
            document.getElementById("fortune-lucky").innerText = fortune['เลขมงคล'] || '-';
            document.getElementById("fortune-advice").innerText = fortune['คำแนะนำ'] || 'จงมีสติในการดำเนินชีวิต';
            
            document.getElementById("loading-indicator").style.display = 'none';
            document.getElementById("fortune-container").style.display = 'block';
        } else {
            displayError(data.message || "ข้อมูลที่ได้รับไม่ถูกต้อง");
        }
    }

    function displayError(message = "ไม่สามารถรับคำทำนายได้ในขณะนี้") {
        document.getElementById("loading-indicator").innerHTML = `<p>ขออภัย, ${message}</p>`;
    }

    function retry() {
        const button = document.querySelector('button');
        button.disabled = true;
        button.innerText = 'กำลังสุ่มใหม่...';
        window.location.reload();
    }
</script>
